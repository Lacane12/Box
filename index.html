<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Unity WebGL Player | Box Catcher</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDE616vYd1GXNVw34KmG0ICCvxfLOSnS2g",
      authDomain: "boxcatcher-519eb.firebaseapp.com",
      projectId: "boxcatcher-519eb",
      storageBucket: "boxcatcher-519eb.appspot.com",
      messagingSenderId: "933279915257",
      appId: "1:933279915257:web:d81f878272a545ab5a9628",
      measurementId: "G-9CH0V0YXD5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    window.GetRecordFromFirebase = async function (telegramId) {
      const snap = await getDoc(doc(db, "records", telegramId));
      const record = snap.exists() ? (snap.data().score || 0) : 0;
      window.unityInstance?.SendMessage("GameManager", "OnFirebaseRecord", record.toString());
    };

    window.SaveRecordToFirebase = async function (telegramId, newScoreStr) {
      const newScore = +newScoreStr;
      const ref = doc(db, "records", telegramId);
      const snap = await getDoc(ref);
      const old = snap.exists() ? (snap.data().score || 0) : 0;
      if (newScore > old) await setDoc(ref, { score: newScore });
    };
  </script>
</head>
<body style="margin:0;padding:0;text-align:center;">
  <canvas id="unity-canvas" width="320" height="720"
          style="width:320px;height:720px;background:#231F20;"></canvas>
  <script src="Build/tg2.loader.js"></script>
  <script>
    let unityInstance = null;
    window.unityInstance = null;

    async function svgToPngDataUrl(url) {
      const resp = await fetch(url);
      const svgText = await resp.text();
      const blob = new Blob([svgText], {type:"image/svg+xml"});
      const imgUrl = URL.createObjectURL(blob);
      return new Promise((res, rej) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          const c = document.createElement("canvas");
          c.width = img.width || 128;
          c.height = img.height || 128;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, c.width, c.height);
          URL.revokeObjectURL(imgUrl);
          res(c.toDataURL("image/png"));
        };
        img.onerror = e => { URL.revokeObjectURL(imgUrl); rej(e); };
        img.src = imgUrl;
      });
    }

    async function sendAvatarFromProxy(username) {
  if (!username) return;

  // Правильный URL
  const proxyURL = `https://telegram-avatar-api-production.up.railway.app/avatar?username=${encodeURIComponent(username)}`;

  try {
    const response = await fetch(proxyURL);
    const data = await response.json();

    if (!data.avatar) {
      throw new Error("Нет ссылки на аватар");
    }

    const imageUrl = data.avatar;
    const imageResponse = await fetch(imageUrl);
    const blob = await imageResponse.blob();

    const reader = new FileReader();
    reader.onloadend = function () {
      const base64data = reader.result; 

      if (typeof unityInstance !== 'undefined') {
        unityInstance.SendMessage('GameManager', 'OnAvatarBase64', base64data);
        console.log('Изображение отправлено в Unity.');
      } else {
        console.warn('Unity инстанс не найден!');
      }
    };
    reader.readAsDataURL(blob);

  } catch (err) {
    console.error("Ошибка загрузки или обработки аватара:", err);
  }
}

    

    window.addEventListener("load", () => {
      let payload = null;

      if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        const u = window.Telegram.WebApp.initDataUnsafe.user;
        window.Telegram.WebApp.expand();
        const username = u.username || "";
        payload = JSON.stringify({
          id: u.id,
          name: username || `${u.first_name} ${u.last_name || ""}`.trim(),
          username: username
        });

        createUnityInstance(document.querySelector("#unity-canvas"), {
          dataUrl: "Build/tg2.data",
          frameworkUrl: "Build/tg2.framework.js",
          codeUrl: "Build/tg2.wasm",
          streamingAssetsUrl: "StreamingAssets",
          companyName: "DefaultCompany",
          productName: "Box Catcher",
          productVersion: "1.0.2",
        }).then(inst => {
          unityInstance = inst;
          window.unityInstance = inst;
          inst.SendMessage("GameManager", "OnTelegramUser", payload);
          if (username) sendAvatarFromProxy(username);
          window.GetRecordFromFirebase(u.id.toString());
        }).catch(console.error);
      }
    });

    // Mobile viewport hack
    if (/Android|iPhone/i.test(navigator.userAgent)) {
      const m = document.createElement("meta");
      m.name = "viewport";
      m.content = "width=device-width,height=device-height,initial-scale=1.0,user-scalable=no,shrink-to-fit=yes";
      document.head.appendChild(m);
      const c = document.querySelector("#unity-canvas");
      Object.assign(c.style, {width: "100%", height: "100%", position: "fixed"});
      document.body.style.textAlign = "left";
    }
  </script>
</body>
</html>
