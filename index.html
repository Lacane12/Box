<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Unity WebGL Player | Box Catcher</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDE616vYd1GXNVw34KmG0ICCvxfLOSnS2g",
      authDomain: "boxcatcher-519eb.firebaseapp.com",
      projectId: "boxcatcher-519eb",
      storageBucket: "boxcatcher-519eb.appspot.com",
      messagingSenderId: "933279915257",
      appId: "1:933279915257:web:d81f878272a545ab5a9628",
      measurementId: "G-9CH0V0YXD5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.GetRecordFromFirebase = async function (telegramId) {
      const docRef = doc(db, "records", telegramId);
      const docSnap = await getDoc(docRef);
      let record = 0;
      if (docSnap.exists()) record = docSnap.data().score || 0;
      if (window.unityInstance)
        unityInstance.SendMessage("GameManager", "OnFirebaseRecord", record.toString());
    };

    window.SaveRecordToFirebase = async function (telegramId, newScoreStr) {
      const newScore = parseInt(newScoreStr);
      const docRef = doc(db, "records", telegramId);
      const docSnap = await getDoc(docRef);
      let oldScore = 0;
      if (docSnap.exists()) oldScore = docSnap.data().score || 0;

      if (newScore > oldScore) {
        await setDoc(docRef, { score: newScore });
        console.log(`Новый рекорд сохранён: ${newScore}`);
      } else {
        console.log(`Рекорд не побит: ${newScore} <= ${oldScore}`);
      }
    };
  </script>
</head>

<body style="text-align: center; padding: 0; border: 0; margin: 0;">
  <canvas id="unity-canvas" width="320" height="720"
          style="width: 320px; height: 720px; background: #231F20"></canvas>

  <script src="Build/tg2.loader.js"></script>

  <script>
    let unityInstance = null;

    async function convertSvgToPngDataUrl(svgUrl) {
      try {
        const res = await fetch(svgUrl);
        const svgText = await res.text();

        const blob = new Blob([svgText], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);

        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            URL.revokeObjectURL(url);
            resolve(canvas.toDataURL("image/png"));
          };
          img.onerror = err => {
            URL.revokeObjectURL(url);
            reject("Ошибка загрузки изображения");
          };
          img.src = url;
        });
      } catch (err) {
        console.error("Ошибка при рендере SVG:", err);
        return null;
      }
    }

    async function handleAvatarForUnity(avatarUrl) {
      if (!avatarUrl) return;

      if (avatarUrl.endsWith('.svg')) {
        const pngDataUrl = await convertSvgToPngDataUrl(avatarUrl);
        if (pngDataUrl) {
          unityInstance.SendMessage("GameManager", "OnAvatarBase64", pngDataUrl);
        }
      } else {
        unityInstance.SendMessage("GameManager", "OnAvatarBase64", avatarUrl);
      }
    }

    window.addEventListener('load', () => {
      let telegramPayload = null;

      if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        const user = tg.initDataUnsafe.user;

        telegramPayload = JSON.stringify({
          id: user.id,
          name: user.username || `${user.first_name} ${user.last_name || ''}`.trim(),
          avatar: user.photo_url ? (user.photo_url.startsWith("http") ? user.photo_url : `https://t.me${user.photo_url}`) : ""
        });
      }

      createUnityInstance(document.querySelector("#unity-canvas"), {
        dataUrl: "Build/tg2.data",
        frameworkUrl: "Build/tg2.framework.js",
        codeUrl: "Build/tg2.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Box Catcher",
        productVersion: "1.0.2",
      }).then(instance => {
        unityInstance = instance;

        if (telegramPayload) {
          const tgData = JSON.parse(telegramPayload);
          setTimeout(() => {
            unityInstance.SendMessage("GameManager", "OnTelegramUser", telegramPayload);
            handleAvatarForUnity(tgData.avatar);
          }, 500);
        }
      }).catch(err => {
        console.error("Ошибка инициализации Unity:", err);
      });
    });

    // Мобильная адаптация
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      var meta = document.createElement('meta');
      meta.name = 'viewport';
      meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
      document.getElementsByTagName('head')[0].appendChild(meta);

      var canvas = document.querySelector("#unity-canvas");
      canvas.style.width = "100%";
      canvas.style.height = "100%";
      canvas.style.position = "fixed";
      document.body.style.textAlign = "left";
    }
  </script>
</body>
</html>
